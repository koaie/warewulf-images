FROM tea.intra.kat.sh/koa/rocky:latest

RUN dnf -y update && \
    dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel10/x86_64/cuda-rhel10.repo && \
    dnf -y install --allowerasing --setopt=install_weak_deps=False \
    datacenter-gpu-manager-4-proprietary \
    datacenter-gpu-manager-4-core \
    nvidia-driver-cuda \
    nvtop \
    kernel-headers	\
	kernel-devel-matched \
    gcc \
    openssl \
    make && \
    \
    dkms autoinstall -k $(rpm -qa kernel-core | sort -Vr | head -n 1 | cut -d- -f3-) && \
    \
    dnf remove -y \
    kernel-devel-matched \
    kernel-headers \
    gcc \
    make && \
    \
    dnf clean all
